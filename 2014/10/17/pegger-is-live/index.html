<!DOCTYPE html>
<html class="no-js">
<head>
	<meta charset="utf-8">
	<title>Pegger is Live! | Technical Rex</title>
	<meta name="description" content="The finishing touches have been made and I think it's time to call Pegger "good enough". Read on for some changes I made to the code to put that last bit of ...">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	<meta http-equiv="X-Frame-Options" content="sameorigin">

	<link rel="stylesheet" href="/css/main.css">

	<link rel="canonical" href="http://technicalrex.com/2014/10/17/pegger-is-live">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">

	<!-- For IE 9 and below. ICO should be 32x32 pixels in size -->
<!--[if IE]><link rel="shortcut icon" href="/img/icons/favicon.ico"><![endif]-->

<!-- Touch Icons - iOS and Android 2.1+ 180x180 pixels in size. -->
<link rel="apple-touch-icon" href="/img/icons/apple-touch-icon.png">

<!-- Firefox, Chrome, Safari, IE 11+ and Opera. 196x196 pixels in size. -->
<link rel="icon" href="/img/icons/favicon.png">

	<meta property="article:published_time" content="2014-10-17T00:00:00-04:00" />
<meta property="article:modified_time" content="2014-10-17T00:00:00-04:00" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Pegger is Live!" />
<meta property="og:url" content="http://technicalrex.com/2014/10/17/pegger-is-live" />
<meta property="og:description" content="The finishing touches have been made and I think it&#39;s time to call Pegger &quot;good enough&quot;. Read on for some changes I made to the code to put that last bit of polish on this wittle web ..." />
<meta property="og:site_name" content="Technical Rex" />
<meta property="og:locale" content="en_US" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@eriklgillespie" />
<meta name="twitter:creator" content="@eriklgillespie" />


</head>

<body>
    <div id="landscape">
        <header class="site-header">
	<div class="branding flow-nav">
		<h1 class="site-title">
			<a href="/">
				<img class="favicon" src="/img/icons/favicon.png"/>
				Technical Rex
			</a>
		</h1>
	</div>
	<nav class="site-nav flow-nav">
		<ul class="flow-nav">
			
			
			<li class="flow-nav">
				<a class="page-link" href="/about.html">About</a>
			</li>
			
			
			
			<li class="flow-nav">
				<a class="page-link" href="/apps.html">Apps</a>
			</li>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			<li class="flow-nav">
				<a href="/feed.xml" title="">
					<i class="fa fa-fw fa-rss"></i>
				</a>
			</li>
		</ul>
	</nav>
</header>

        <div id="page-container">
            <div class="underlay">
    <div class="content">
        <article>
            <header class="post-header">
                <h1 class="title">Pegger is Live!</h1>
                <p class="about">
                    Posted  by Erik Gillespie
                    on October 17, 2014
                </p>
            </header>
            <section class="post-content"><p>The finishing touches have been made and I think it’s time to call Pegger <a href="http://en.wikipedia.org/wiki/Principle_of_good_enough">“good enough”</a>.</p>

<p>You can play Pegger at it’s permanent home: <a href="http://pegger.technicalrex.com">pegger.technicalrex.com</a>. If you want to learn more about those finishing touches, read on!</p>

<h2 id="user-experience-tweaks">User Experience Tweaks</h2>

<p>After the <a href="/2014/10/01/using-bootstrap-and-angularjs-for-a-simple-turn-based-game">previous tutorial</a> Pegger was still pretty rough around the edges. The game was playable but only if you could figure out the rules by guessing or were brave enough to check out the source code or README on <a href="https://github.com/egillespie/pegger">GitHub</a>.</p>

<p>Besides a lack of rules there were a few broken links and as a user on <a href="http://www.reddit.com/r/programming/comments/2hzoml/a_simple_turnbased_game_client_using_bootstrap/">Reddit</a> pointed out, it was unclear that the white circles were holes and not interactive.</p>

<p>The interface has been cleaned up and all of the aforementioned issues have been addressed.</p>

<p>The rules are now on permanent display below the game board with small peg icons displayed where appropriate to draw attention to differences between the various colors of pegs and the white holes.</p>

<p>The game board has been touched up too. Namely,</p>

<ol>
  <li>The current player is displayed seamlessly in the upper right corner.</li>
  <li>Game messages are displayed at the bottom of the board and are much less distracting.</li>
  <li>The mouse pointer changes only when hovering over an interactive hole or peg.</li>
  <li>Selecting a different peg actually works now instead of displaying an error.</li>
</ol>

<p>All links are now valid too. Instead of mixing the tutorial/code part of Pegger with the rules, the Tutorial and GitHub links were moved to the upper right of the page to be more prominently displayed but still out of the way from the game play.</p>

<h2 id="cleaning-up-old-games">Cleaning Up Old Games</h2>

<p>Since Pegger does not use any permanent storage it is important to keep the in-memory repository small as it will inevitably grow in size over time. This was handled by tracking the time that each game was last updated and introducing a scheduled task in the Pegger web app.</p>

<p>To track the time that each game changed, first I added Joda Time and a Jackson module to allow us to include the new field in our JSON as Maven dependencies:</p>

<p><strong>pegger-war/pom.xml</strong></p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno"> 1</span> <span class="nt">&lt;dependencies&gt;</span>
<span class="lineno"> 2</span>     <span class="nt">&lt;dependency&gt;</span>
<span class="lineno"> 3</span>         <span class="nt">&lt;groupId&gt;</span>joda-time<span class="nt">&lt;/groupId&gt;</span>
<span class="lineno"> 4</span>         <span class="nt">&lt;artifactId&gt;</span>joda-time<span class="nt">&lt;/artifactId&gt;</span>
<span class="lineno"> 5</span>         <span class="nt">&lt;version&gt;</span>2.5<span class="nt">&lt;/version&gt;</span>
<span class="lineno"> 6</span>     <span class="nt">&lt;/dependency&gt;</span>
<span class="lineno"> 7</span>     <span class="nt">&lt;dependency&gt;</span>
<span class="lineno"> 8</span>         <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.datatype<span class="nt">&lt;/groupId&gt;</span>
<span class="lineno"> 9</span>         <span class="nt">&lt;artifactId&gt;</span>jackson-datatype-joda<span class="nt">&lt;/artifactId&gt;</span>
<span class="lineno">10</span>         <span class="nt">&lt;version&gt;</span>2.4.3<span class="nt">&lt;/version&gt;</span>
<span class="lineno">11</span>     <span class="nt">&lt;/dependency&gt;</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>     ...
<span class="lineno">14</span> <span class="nt">&lt;/dependencies&gt;</span></code></pre></div>

<p>Then, the Joda Time module needed to be included in the Jackson ObjectMapper configuration:</p>

<p><strong>JacksonObjectMapperConfig.java</strong></p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">1</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">JacksonObjectMapperConfig</span> <span class="kd">implements</span> <span class="n">ContextResolver</span><span class="o">&lt;</span><span class="n">ObjectMapper</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="lineno">2</span>     <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ObjectMapper</span> <span class="n">OBJECT_MAPPER</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ObjectMapper</span><span class="o">()</span>
<span class="lineno">3</span>             <span class="o">.</span><span class="na">disable</span><span class="o">(</span><span class="n">MapperFeature</span><span class="o">.</span><span class="na">AUTO_DETECT_CREATORS</span><span class="o">)</span>
<span class="lineno">4</span>             <span class="o">.</span><span class="na">disable</span><span class="o">(</span><span class="n">MapperFeature</span><span class="o">.</span><span class="na">CAN_OVERRIDE_ACCESS_MODIFIERS</span><span class="o">)</span>
<span class="lineno">5</span>             <span class="o">.</span><span class="na">registerModule</span><span class="o">(</span><span class="k">new</span> <span class="nf">GuavaModule</span><span class="o">())</span>
<span class="lineno">6</span>             <span class="o">.</span><span class="na">registerModule</span><span class="o">(</span><span class="k">new</span> <span class="nf">JodaModule</span><span class="o">());</span>
<span class="lineno">7</span> 
<span class="lineno">8</span>     <span class="c1">// ...</span>
<span class="lineno">9</span> <span class="o">}</span></code></pre></div>

<p>Finally, I added the field to the Game class. Here are the relevant changes:</p>

<p><strong>Game.java</strong></p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Game</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="c1">// ...</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span>     <span class="kd">private</span> <span class="kd">final</span> <span class="n">Instant</span> <span class="n">lastChangeTimestamp</span><span class="o">;</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>     <span class="kd">private</span> <span class="nf">Game</span><span class="o">(</span><span class="n">UUID</span> <span class="n">gameId</span><span class="o">,</span> <span class="n">Peg</span> <span class="n">lastPegMoved</span><span class="o">,</span> <span class="n">ImmutableSet</span><span class="o">&lt;</span><span class="n">Peg</span><span class="o">&gt;</span> <span class="n">pegs</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 7</span>         <span class="k">this</span><span class="o">.</span><span class="na">gameId</span> <span class="o">=</span> <span class="n">Preconditions</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">gameId</span><span class="o">);</span>
<span class="lineno"> 8</span>         <span class="k">this</span><span class="o">.</span><span class="na">lastPegMoved</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">fromNullable</span><span class="o">(</span><span class="n">lastPegMoved</span><span class="o">);</span>
<span class="lineno"> 9</span>         <span class="k">this</span><span class="o">.</span><span class="na">pegs</span> <span class="o">=</span> <span class="n">Maps</span><span class="o">.</span><span class="na">uniqueIndex</span><span class="o">(</span><span class="n">Preconditions</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">pegs</span><span class="o">),</span> <span class="n">PEG_INDEXER</span><span class="o">);</span>
<span class="lineno">10</span>         <span class="k">this</span><span class="o">.</span><span class="na">gameOver</span> <span class="o">=</span> <span class="n">calculateGameOver</span><span class="o">();</span>
<span class="lineno">11</span>         <span class="k">this</span><span class="o">.</span><span class="na">lastChangeTimestamp</span> <span class="o">=</span> <span class="n">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
<span class="lineno">12</span>         <span class="n">validateGameState</span><span class="o">();</span>
<span class="lineno">13</span>     <span class="o">}</span>
<span class="lineno">14</span> 
<span class="lineno">15</span>     <span class="c1">// ...</span>
<span class="lineno">16</span> 
<span class="lineno">17</span>     <span class="kd">public</span> <span class="n">Instant</span> <span class="nf">getLastChangeTimestamp</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">18</span>         <span class="k">return</span> <span class="n">lastChangeTimestamp</span><span class="o">;</span>
<span class="lineno">19</span>     <span class="o">}</span>
<span class="lineno">20</span> 
<span class="lineno">21</span>     <span class="c1">// ...</span>
<span class="lineno">22</span> 
<span class="lineno">23</span>     <span class="nd">@Override</span>
<span class="lineno">24</span>     <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">25</span>         <span class="k">return</span> <span class="n">MoreObjects</span><span class="o">.</span><span class="na">toStringHelper</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
<span class="lineno">26</span>                 <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;gameId&quot;</span><span class="o">,</span> <span class="n">gameId</span><span class="o">)</span>
<span class="lineno">27</span>                 <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;lastPegMoved&quot;</span><span class="o">,</span> <span class="n">lastPegMoved</span><span class="o">)</span>
<span class="lineno">28</span>                 <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;gameOver&quot;</span><span class="o">,</span> <span class="n">gameOver</span><span class="o">)</span>
<span class="lineno">29</span>                 <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;lastChangeTimestamp&quot;</span><span class="o">,</span> <span class="n">lastChangeTimestamp</span><span class="o">)</span>
<span class="lineno">30</span>                 <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;pegs&quot;</span><span class="o">,</span> <span class="n">pegs</span><span class="o">)</span>
<span class="lineno">31</span>                 <span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="lineno">32</span>     <span class="o">}</span>
<span class="lineno">33</span> <span class="o">}</span></code></pre></div>

<p>With the tracking of the time that each game last changed in place, the last piece (and it’s a big one) is to automatically remove old games every so often. Since Pegger is hosted in Google App Engine, I decided to use their <a href="https://cloud.google.com/appengine/docs/java/config/cron">task scheduler</a> to do this.</p>

<p>Google’s Task Scheduler fits in nicely with the HTTP API approach that I used with Pegger. In order to schedule a task, I simply needed to create a new resource that will respond to an HTTP GET request and the scheduler will automatically make requests to this URI at whatever interval I decide. This also means that I can manually invoke the task by entering the correct URL in a browser.</p>

<p>The first step to introduce this task is to create a new file named <code>cron.xml</code> that outlines the name of the new resource and how frequently it will be invoked.</p>

<p><strong>pegger-war/src/main/webapp/WEB-INF/cron.xml</strong></p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno">1</span> <span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="lineno">2</span> <span class="nt">&lt;cronentries&gt;</span>
<span class="lineno">3</span> <span class="nt">&lt;cron&gt;</span>
<span class="lineno">4</span> <span class="nt">&lt;url&gt;</span>/tools/clean_games<span class="nt">&lt;/url&gt;</span>
<span class="lineno">5</span> <span class="nt">&lt;description&gt;</span>Remove old games every 12 hours<span class="nt">&lt;/description&gt;</span>
<span class="lineno">6</span> <span class="nt">&lt;schedule&gt;</span>every 12 hours<span class="nt">&lt;/schedule&gt;</span>
<span class="lineno">7</span> <span class="nt">&lt;/cron&gt;</span>
<span class="lineno">8</span> <span class="nt">&lt;/cronentries&gt;</span></code></pre></div>

<p>Looks weird, right? I discovered that there is a bug in Google App Engine that prevents some people from uploading their <code>cron.xml</code> file to App Engine unless all preceding whitespace is removed. Unfortunately, it happened to me so I removed the whitespace and recommend that you do the same, just in case. <a href="https://code.google.com/p/googleappengine/issues/detail?id=1537">More info about the bug here.</a></p>

<p>I decided to separate this resource out from all of the resources available at <code>/games</code> which will be handy for securing this resource (which I will do later in this tutorial). The other decision here was that the clean-up resource would be requested every 12 hours.</p>

<p>Next, I created the new resource and made sure Jersey knew about it:</p>

<p><strong>com/technicalrex/webapp/pegger/api/ToolResource.java</strong></p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/tools&quot;</span><span class="o">)</span>
<span class="lineno"> 2</span> <span class="nd">@Produces</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
<span class="lineno"> 3</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ToolResource</span> <span class="o">{</span>
<span class="lineno"> 4</span>     <span class="kd">private</span> <span class="kd">final</span> <span class="n">GameTools</span> <span class="n">gameTools</span><span class="o">;</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span>     <span class="nd">@Inject</span>
<span class="lineno"> 7</span>     <span class="kd">public</span> <span class="nf">ToolResource</span><span class="o">(</span><span class="n">GameTools</span> <span class="n">gameTools</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span>         <span class="k">this</span><span class="o">.</span><span class="na">gameTools</span> <span class="o">=</span> <span class="n">Preconditions</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">gameTools</span><span class="o">);</span>
<span class="lineno"> 9</span>     <span class="o">}</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>     <span class="nd">@GET</span>
<span class="lineno">12</span>     <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;clean_games&quot;</span><span class="o">)</span>
<span class="lineno">13</span>     <span class="kd">public</span> <span class="n">Response</span> <span class="nf">cleanOldGames</span><span class="o">(</span><span class="nd">@QueryParam</span><span class="o">(</span><span class="s">&quot;maxAgeInHours&quot;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">maxAgeInHours</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">14</span>         <span class="kt">int</span> <span class="n">gamesRemoved</span><span class="o">;</span>
<span class="lineno">15</span>         <span class="k">if</span> <span class="o">(</span><span class="n">maxAgeInHours</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">16</span>             <span class="n">gamesRemoved</span> <span class="o">=</span> <span class="n">gameTools</span><span class="o">.</span><span class="na">removeOldGames</span><span class="o">();</span>
<span class="lineno">17</span>         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="lineno">18</span>             <span class="n">gamesRemoved</span> <span class="o">=</span> <span class="n">gameTools</span><span class="o">.</span><span class="na">removeOldGames</span><span class="o">(</span><span class="n">maxAgeInHours</span><span class="o">);</span>
<span class="lineno">19</span>         <span class="o">}</span>
<span class="lineno">20</span>         <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="n">ImmutableMap</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;removed&quot;</span><span class="o">,</span> <span class="n">gamesRemoved</span><span class="o">)).</span><span class="na">build</span><span class="o">();</span>
<span class="lineno">21</span>     <span class="o">}</span>
<span class="lineno">22</span> <span class="o">}</span></code></pre></div>

<p><strong>JerseyConfig.java</strong></p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">1</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">JerseyConfig</span> <span class="kd">extends</span> <span class="n">ResourceConfig</span> <span class="o">{</span>
<span class="lineno">2</span>     <span class="kd">public</span> <span class="nf">JerseyConfig</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">3</span>         <span class="c1">// ...</span>
<span class="lineno">4</span> 
<span class="lineno">5</span>         <span class="n">register</span><span class="o">(</span><span class="n">ToolResource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="lineno">6</span>     <span class="o">}</span>
<span class="lineno">7</span> <span class="o">}</span></code></pre></div>

<p>You can see that instead of simply supporting a GET request at <code>/tools/clean_games</code> I also added support for a query parameter that will allow me to override the maximum age of games that are retained on the server. I thought this would be handy in case someone spams the site and creates an obnoxious number of games. In that case I could simply pass in a value of “0” to clear out all games.</p>

<p>The resource will call into a new service named <code>GameTools</code> to do the real work and then respond with the number of games that were removed. Here’s the implementation for <code>GameTools</code>:</p>

<p><strong>com/technicalrex/webapp/pegger/api/games/GameTools.java</strong></p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno"> 1</span> <span class="nd">@Service</span>
<span class="lineno"> 2</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">GameTools</span> <span class="o">{</span>
<span class="lineno"> 3</span>     <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">GameTools</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span>     <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">DEFAULT_MAX_AGE_IN_HOURS</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="o">;</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span>     <span class="kd">private</span> <span class="kd">final</span> <span class="n">GameRepository</span> <span class="n">gameRepository</span><span class="o">;</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span>     <span class="nd">@Inject</span>
<span class="lineno">10</span>     <span class="kd">public</span> <span class="nf">GameTools</span><span class="o">(</span><span class="n">GameRepository</span> <span class="n">gameRepository</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">11</span>         <span class="k">this</span><span class="o">.</span><span class="na">gameRepository</span> <span class="o">=</span> <span class="n">Preconditions</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">gameRepository</span><span class="o">);</span>
<span class="lineno">12</span>     <span class="o">}</span>
<span class="lineno">13</span> 
<span class="lineno">14</span>     <span class="kd">public</span> <span class="kt">int</span> <span class="nf">removeOldGames</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno">15</span>         <span class="k">return</span> <span class="nf">removeOldGames</span><span class="o">(</span><span class="n">DEFAULT_MAX_AGE_IN_HOURS</span><span class="o">);</span>
<span class="lineno">16</span>     <span class="o">}</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>     <span class="kd">public</span> <span class="kt">int</span> <span class="nf">removeOldGames</span><span class="o">(</span><span class="kt">long</span> <span class="n">maxAgeInHours</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">19</span>         <span class="n">Instant</span> <span class="n">maxAgeTimestamp</span> <span class="o">=</span> <span class="n">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">minus</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">standardHours</span><span class="o">(</span><span class="n">maxAgeInHours</span><span class="o">));</span>
<span class="lineno">20</span>         <span class="kt">int</span> <span class="n">totalGames</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">gamesRemoved</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="lineno">21</span>         <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Game</span><span class="o">&gt;</span> <span class="n">allGames</span> <span class="o">=</span> <span class="n">gameRepository</span><span class="o">.</span><span class="na">getAll</span><span class="o">();</span>
<span class="lineno">22</span>         <span class="k">for</span> <span class="o">(</span><span class="n">Game</span> <span class="n">game</span> <span class="o">:</span> <span class="n">allGames</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">23</span>             <span class="n">totalGames</span><span class="o">++;</span>
<span class="lineno">24</span>             <span class="k">if</span> <span class="o">(</span><span class="n">game</span><span class="o">.</span><span class="na">getLastChangeTimestamp</span><span class="o">().</span><span class="na">isBefore</span><span class="o">(</span><span class="n">maxAgeTimestamp</span><span class="o">))</span> <span class="o">{</span>
<span class="lineno">25</span>                 <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Game</span><span class="o">&gt;</span> <span class="n">removedGame</span> <span class="o">=</span> <span class="n">gameRepository</span><span class="o">.</span><span class="na">deleteById</span><span class="o">(</span><span class="n">game</span><span class="o">.</span><span class="na">getGameId</span><span class="o">());</span>
<span class="lineno">26</span>                 <span class="k">if</span> <span class="o">(</span><span class="n">removedGame</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
<span class="lineno">27</span>                     <span class="n">gamesRemoved</span><span class="o">++;</span>
<span class="lineno">28</span>                 <span class="o">}</span>
<span class="lineno">29</span>             <span class="o">}</span>
<span class="lineno">30</span>         <span class="o">}</span>
<span class="lineno">31</span>         <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Removed %d games that were more than %d hours old.&quot;</span><span class="o">,</span> <span class="n">gamesRemoved</span><span class="o">,</span> <span class="n">maxAgeInHours</span><span class="o">));</span>
<span class="lineno">32</span>         <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;There are now %d active games.&quot;</span><span class="o">,</span> <span class="n">totalGames</span> <span class="o">-</span> <span class="n">gamesRemoved</span><span class="o">));</span>
<span class="lineno">33</span>         <span class="k">return</span> <span class="n">gamesRemoved</span><span class="o">;</span>
<span class="lineno">34</span>     <span class="o">}</span>
<span class="lineno">35</span> <span class="o">}</span></code></pre></div>

<p>As I filled in more of the gaps to implement this feature I discovered more changes that needed to be made. The first change is that there needed to be an additional repository method added to <code>GameRepository</code> to permanently delete a game. Fortunately this operation is pretty straight forward since our games are stored in a map:</p>

<p><strong>GameRepository.java</strong></p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="lineno">1</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">GameRepository</span> <span class="o">{</span>
<span class="lineno">2</span>     <span class="c1">// ...</span>
<span class="lineno">3</span> 
<span class="lineno">4</span>     <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Game</span><span class="o">&gt;</span> <span class="nf">deleteById</span><span class="o">(</span><span class="n">UUID</span> <span class="n">gameId</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno">5</span>         <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">fromNullable</span><span class="o">(</span><span class="n">REPO</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">gameId</span><span class="o">));</span>
<span class="lineno">6</span>     <span class="o">}</span>
<span class="lineno">7</span> <span class="o">}</span></code></pre></div>

<p>The other change that I had to make was the default logging level for the tool. Initially, I had configured Java Logging to only log WARNING messages. For this tool it would be useful to see the output every time the resource is requested. In order to accomplish this I added a line to <code>logging.properties</code>:</p>

<p><strong>logging.properties</strong></p>

<div class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="lineno">1</span> <span class="c"># Set the default logging level for all loggers to WARNING</span>
<span class="lineno">2</span> <span class="na">.level</span> <span class="o">=</span> <span class="s">WARNING</span>
<span class="lineno">3</span> 
<span class="lineno">4</span> <span class="c"># Tools run at INFO by default</span>
<span class="lineno">5</span> <span class="na">GameTools.level</span> <span class="o">=</span> <span class="s">INFO</span></code></pre></div>

<p>Voilà! Google App Engine will now make a GET request to <code>/tools/clean_games</code> every 12 hours and any games that haven’t been changed in more than 7 days will be removed. We can also manually request this resource to force the task to do clean up. This imposes a problem though: I don’t want just anyone to be able to delete games!</p>

<p>Fortunately Google allows users to be granted an “admin” role and this role is exposed to the Java servlet container so URLs can be restricted to this role. Not only that, but the task scheduler is automatically granted the “admin” role so it can continue to make requests to its configured resources without any further configuration in <code>cron.xml</code>.</p>

<p><strong>web.xml</strong></p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno"> 1</span> <span class="nt">&lt;web-app&gt;</span>
<span class="lineno"> 2</span>     // ...
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span>     <span class="nt">&lt;security-constraint&gt;</span>
<span class="lineno"> 5</span>         <span class="nt">&lt;web-resource-collection&gt;</span>
<span class="lineno"> 6</span>             <span class="nt">&lt;web-resource-name&gt;</span>tools<span class="nt">&lt;/web-resource-name&gt;</span>
<span class="lineno"> 7</span>             <span class="nt">&lt;url-pattern&gt;</span>/tools/*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="lineno"> 8</span>         <span class="nt">&lt;/web-resource-collection&gt;</span>
<span class="lineno"> 9</span>         <span class="nt">&lt;auth-constraint&gt;</span>
<span class="lineno">10</span>             <span class="nt">&lt;role-name&gt;</span>admin<span class="nt">&lt;/role-name&gt;</span>
<span class="lineno">11</span>         <span class="nt">&lt;/auth-constraint&gt;</span>
<span class="lineno">12</span>     <span class="nt">&lt;/security-constraint&gt;</span>
<span class="lineno">13</span> <span class="nt">&lt;/web-app&gt;</span></code></pre></div>

<p>What this really means is that we can make a small addition to <code>web.xml</code> and any resource starting with <code>/tools/</code> will be locked down such that only Pegger admins and the task scheduler can access them.</p>

<h2 id="creating-peggertechnicalrexcom">Creating pegger.technicalrex.com</h2>

<p>The last change I wanted to make to Pegger was the URL where people could go to play it. Ideally, it would appear to be hosted alongside this blog and easy to remember. I thought <a href="http://pegger.technicalrex.com">pegger.technicalrex.com</a> would be perfect.</p>

<p>This turned out to be a two-step process:</p>

<ol>
  <li>Prove to Google that I own technicalrex.com.</li>
  <li>Update my DNS settings to point pegger.technicalrex.com at Google’s host.</li>
</ol>

<p>These steps can be a little daunting if you’re not familiar with domain management but there are excellent instructions provided by Google to <a href="https://support.google.com/a/answer/53295?hl=en">add a domain to your Google App account</a>. Of course, you need a Google App account and you need to be an admin in order to complete those instructions.</p>

<p>Right now, WordPress is managing my technicalrex.com domain. For whatever reason, I can not seem to find a way to navigate to my DNS settings from the Technical Rex blog’s dashboard. I always end up poking around for 5-10 minutes before I give up and search the Internet for the location. If you have WordPress manage your domain then I’ll save you the trouble. <a href="https://wordpress.com/my-domains">WordPress domain management is located here.</a>.</p>

<h2 id="the-end">The End</h2>

<p>You’ve reached the end of the Pegger tutorial series, congratulations!</p>

<p>Thank you so much for reading this series, I really hope you have found it helpful. If you ever have any questions or comments, please don’t hesitate to contact me.</p>

<p>Here are some suggestions for feedback:</p>

<ol>
  <li>If you want to request a feature or change to Pegger, <a href="https://github.com/egillespie/pegger/issues">create an Issue on GitHub</a>.</li>
  <li>If you want to contact me privately, <a href="mailto:erik.gillespie@technicalrex.com">email me</a>.</li>
  <li>If you want to ask general questions or provide feedback, comment on the most appropriate article in this <a href="/tag/pegger/">tutorial series</a>.</li>
</ol>

<p>I will still be writing articles here too, so please stop by from time to time! Who knows, maybe I will start up a second Pegger series and talk about some more advanced topics. :)</p>
</section>
            <p class="signature"> - Erik</p>
        </article>
    </div>
</div>

        </div>
        <footer class="site-footer">
	<p class="text">Copyright © 2015 Technical Rex, Inc. Re-use with attribution encouraged. All other rights reserved.</p>
</footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-62666024-3', 'auto');
ga('send', 'pageview');
</script>



    </div>
    <img id="rex" src="/img/rex/rex-main.png"></img>
</body>
</html>
