<!DOCTYPE html>
<html class="no-js">
<head>
	<meta charset="utf-8">
	
	<title>Performance Playground - Jackson vs. Protocol Buffers, Part 3 | Technical Rex</title>
	<meta name="description" content="Writing an apples-to-apples benchmark comparison of two very different serialization frameworks is apparently hard. In my first attempt to compare serializat...">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	<meta http-equiv="X-Frame-Options" content="sameorigin">

	<link rel="stylesheet" href="/css/main.css">

	<link rel="canonical" href="http://technicalrex.com/2015/06/25/performance-playground-jackson-vs-protocol-buffers-part-3">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">

	<!-- For IE 9 and below. ICO should be 32x32 pixels in size -->
<!--[if IE]><link rel="shortcut icon" href="/img/icons/favicon.ico"><![endif]-->

<!-- Touch Icons - iOS and Android 2.1+ 180x180 pixels in size. -->
<link rel="apple-touch-icon" href="/img/icons/apple-touch-icon.png">

<!-- Firefox, Chrome, Safari, IE 11+ and Opera. 196x196 pixels in size. -->
<link rel="icon" href="/img/icons/favicon.png">

	
<meta property="article:published_time" content="2015-06-25T00:00:00-04:00" />
<meta property="article:modified_time" content="2015-06-25T00:00:00-04:00" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Performance Playground - Jackson vs. Protocol Buffers, Part 3 " />
<meta property="og:url" content="http://technicalrex.com/2015/06/25/performance-playground-jackson-vs-protocol-buffers-part-3" />
<meta property="og:description" content="Writing an apples-to-apples benchmark comparison of two very different serialization frameworks is apparently hard. In my first attempt to compare serialization performance of Jackson JSON and Goog..." />
<meta property="og:site_name" content="Technical Rex" />
<meta property="og:locale" content="en_US" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@eriklgillespie" />
<meta name="twitter:creator" content="@eriklgillespie" />


</head>

<body>
    <div id="landscape">
        <header class="site-header">
	<div class="branding flow-nav">
		<h1 class="site-title">
			<a href="/">
				<img class="favicon" src="/img/icons/favicon.png"/>
				Technical Rex
			</a>
		</h1>
	</div>
	<nav class="site-nav flow-nav">
		<ul class="flow-nav">
			
			
			<li class="flow-nav">
				<a class="page-link" href="/about.html">About</a>
			</li>
			
			
			
			<li class="flow-nav">
				<a class="page-link" href="/apps.html">Apps</a>
			</li>
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			<li class="flow-nav">
				<a href="/feed.xml" title="">
					<i class="fa fa-fw fa-rss"></i>
				</a>
			</li>
		</ul>
	</nav>
</header>

        <div id="page-container">
            <div class="underlay">
    <div class="content">
        <article>
            <header class="post-header">
                <h1 class="title">Performance Playground:<br/>Jackson vs. Protocol Buffers, Part 3</h1>
                <p class="about">
                    Posted  by Erik Gillespie
                    on June 25, 2015
                </p>
            </header>
            <section class="post-content"><p>Writing an apples-to-apples benchmark comparison of two very different serialization frameworks is apparently hard.</p>

<p>In my first attempt to compare serialization performance of Jackson JSON and Google Protocol Buffers, there wasn’t a huge difference. After some suggestions, I made some revisions and found Jackson to be much faster than Protocol Buffers.</p>

<p>A <a href="https://github.com/egillespie/performance-playground/issues/7">bug</a> was recently found in the benchmarks and the effect of this bug gave Jackson a pretty unfair advantage. As you’ll see, fixing the bug leads to a complete 180º in the results of these benchmarks.</p>

<h2 id="the-bug-explained">The Bug, Explained</h2>

<p>If I had paid better attention to the serialized JSON and compared it to the data types I was choosing for the serialized object’s <code>.proto</code> format file, I would have seen that the Joda Time serialization of <code>LocalDate</code> objects was not converting the values to strings. Unfortunately, that was exactly what I did when I wrote the translation code to convert my value object to its corresponding -Proto class.</p>

<p><a href="https://github.com/phensley/protobuf-vs-jackson">Patrick Hensley</a> noticed this while taking the time to profile the benchmarks, wrote a fixed benchmark of his own, and pointed out the flaw to me.</p>

<p>Before fixing the bug I profiled the Google Protocol Buffers serialization to see for my own eyes. Here’s what it looks like:</p>

<div class="image-center">
    
    <img src="/img/posts/performance-playground/convert-to-string-profiler-results.png" class="shadow" />
    
    
</div>

<p>The list of methods is sorted by Total Time and you can clearly see that most of the time spent during serialization is in a variety of Joda Time method calls.</p>

<p>Converting those dates to strings is expensive!</p>

<h2 id="squashing-the-bug">Squashing the Bug</h2>

<p>Another observation I made while digging into the code was that the Joda Time Jackson module was serializing the dates into an array of year, month, and day, not a string or UNIX timestamp like I had expected. So in addition to fixing the Protocol Buffer conversion of dates to a string, I also needed to fix the Jackson serialization of dates to match the more natural UNIX timestamp I decided to use with Protocol Buffers.</p>

<p>The approach I took was to migrate away from LocalDate altogether in favor of Instant, which I’m quickly learning is the best, most compact way to represent timestamps if you don’t want to wrestle with timezones (and who does?).</p>

<p>After making this change the profiler tells a much different story. All of the time spent serializing into Google Protocol Buffers is actually within the Google methods, not in other frameworks.</p>

<div class="image-center">
    
    <img src="/img/posts/performance-playground/convert-to-millis-profiler-results.png" class="shadow" />
    
    
</div>

<p>And the new serialization benchmark results are pretty impressive too, Google Protocol Buffers wins the race handily this time:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Framework</th>
      <th style="text-align: right">Average Time (ms)</th>
      <th style="text-align: right">Min. Time (ms)</th>
      <th style="text-align: right">Max. Time (ms)</th>
      <th style="text-align: left">Variance</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Jackson JSON 2.6.0-rc2</td>
      <td style="text-align: right">130</td>
      <td style="text-align: right">122</td>
      <td style="text-align: right">169</td>
      <td style="text-align: left">-0.06% / +0.30%</td>
    </tr>
    <tr>
      <td style="text-align: left">Jackson Afterburner JSON 2.6.0-rc2</td>
      <td style="text-align: right">118</td>
      <td style="text-align: right">115</td>
      <td style="text-align: right">131</td>
      <td style="text-align: left">-0.03% / +0.11%</td>
    </tr>
    <tr>
      <td style="text-align: left">Protocol Buffers 3.0.0-alpha-3</td>
      <td style="text-align: right">41</td>
      <td style="text-align: right">38</td>
      <td style="text-align: right">103</td>
      <td style="text-align: left">-0.07% / +1.51%</td>
    </tr>
  </tbody>
</table>

<h2 id="conclusion">Conclusion</h2>

<p>Profiling: Good.<br />
Attention to detail: Good.<br />
Converting dates to strings: Bad.</p>

<p>If you want to see the rest of the benchmark results, you can read them <a href="https://github.com/egillespie/performance-playground">here</a>.</p>

<p>Also, big thanks to Patrick Hensley for noticing this bug and pointing it out to me! It’s great to see this kind of scrutiny in code on the web. OSS FTW!</p>
</section>
            <p class="signature"> - Erik</p>
        </article>
    </div>
</div>

        </div>
        <footer class="site-footer">
	<p class="text">Copyright © 2015 Technical Rex, Inc. Re-use with attribution encouraged. All other rights reserved.</p>
</footer>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-62666024-3', 'auto');
ga('send', 'pageview');
</script>



    </div>
    <img id="rex" src="/img/rex/rex-main.png"></img>
    <script type="text/javascript" src="/js/retarget-links.js"></script>
</body>
</html>
